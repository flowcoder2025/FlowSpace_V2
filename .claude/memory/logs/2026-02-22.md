# 2026-02-22 Daily Log

## 완료 작업: ComfyUI 파이프라인 개선 Epic (Phase 1~4)

### Phase 1: 프롬프트/워크플로우 개선
- constants.ts 신규 (QUALITY_PRESETS, SAMPLER/SCHEDULER_OPTIONS, PROMPT_PREFIXES, DEFAULT_NEGATIVE_PROMPTS)
- types.ts에 negativePrompt/steps/cfgScale/samplerName/scheduler/qualityPreset 추가
- processor.ts: 품질 프리셋 우선 적용, constants 기반 buildPrompt
- 워크플로우 JSON 4개: _meta.parameters에 negative_prompt/steps/cfg/sampler_name/scheduler 추가
- UI: 품질 프리셋 버튼(draft/standard/high) + Advanced 섹션(neg prompt, sampler, scheduler, steps, CFG)

### Phase 2: 배경제거
- post-processor.ts 신규: removeBackground() — 코너 색상 감지 → tolerance 범위 투명화 → 1px feathering
- character/object 타입 기본 true, tolerance 기본값 30
- UI: Remove Background 체크박스 + tolerance 슬라이더

### Phase 3: Seamless 타일
- tileset-seamless.json 워크플로우 신규 (steps=35, cfg=8, dpmpp_2m, karras)
- workflow-loader.ts: variant 지원 (loadWorkflowTemplate(type, variant?))
- post-processor.ts: blendTileEdges() 추가 (2px 범위 엣지 블렌딩)
- UI: Seamless Tiling 체크박스 (tileset 전용)

### Phase 4: ControlNet 포즈 가이드
- capability-checker.ts 신규: /object_info 조회로 ControlNet 노드/모델 감지 (1분 캐시)
- character-controlnet.json 워크플로우 신규
- /api/comfyui/capabilities GET 엔드포인트
- client.ts: getObjectInfo() 메서드 추가
- processor.ts: ControlNet capability 확인 → variant="controlnet" 또는 fallback
- UI: ControlNet Pose Guide 체크박스 + strength 슬라이더 (미설치 시 비활성)

### 빌드 검증
- tsc ✅ lint ✅ build ✅
- 커밋: 0c9a7ba `feat: ComfyUI 파이프라인 개선 (Phase 1~4)` → push 완료

---

---

## 완료 작업: 에셋-게임 연동 수정 Epic (Phase 1)

### Task 2: 에셋 생성 → Phaser 런타임 로드
- main-scene.ts: ASSET_GENERATED 이벤트 리스너 추가 (create → shutdown 해제)
- asset-studio.tsx: handleComplete()에서 loadAssetToPhaser(asset.id) 호출
- 빌드 에러 수정: barrel import(@/features/assets)가 sharp 번들링 → 직접 import로 변경

### Task 3: 맵 에디터에서 생성된 에셋 사용
- editor-store.ts: paletteTab에 "assets" 추가, selectedAssetId 상태
- asset-palette.tsx: NEW — 완료 에셋 목록, 타입 필터, 썸네일 그리드
- editor-sidebar.tsx: "에셋" 3번째 탭 추가
- use-editor.ts: setAssetSelection(), placeObject에 assetId 포함
- space-client.tsx: 새 props 전달

### Task 4: 생성된 캐릭터 → 아바타 적용
- avatar-editor-modal.tsx: [파츠 조합 | AI 캐릭터] 탭 추가
- sprite-generator.ts: custom 타입 동적 로드 + Canvas 스케일 다운 (128x128→32x48)
- 비동기 로드 + 기본 파츠 fallback 패턴

### 추가: 전체 UI 한글화 + 상세 툴팁
- 13개 파일 한글화 (prompt-editor, asset-generate-form, asset-studio, asset-preview 등)
- 모든 필드에 title 속성으로 상세 한글 설명 추가
- ControlNet "(미설치)" → "(설정 필요)" 변경

### 추가: ControlNet 설치
- comfyui_controlnet_aux 노드 설치 (custom_nodes/)
- control_v11p_sd15_openpose.pth 모델 다운로드 (1.38GB)
- Python 의존성 설치 (scipy, einops, fvcore 등)

### 빌드 검증
- tsc ✅ lint ✅ build ✅
- 커밋 대기 (다음 세션에서 진행)

### Handoff Notes
- ~~다음 세션: git commit + push 진행~~
- ~~커밋 대상: 에셋-게임 연동 + UI 한글화 + ControlNet 설치~~

---

## 03:xx - 에셋 갤러리 리팩토링 + 에셋 생성 테스트

### Completed
- [x] 에셋 스튜디오 → 에셋 갤러리 리팩토링 (커밋: 7a8287a)
  - 삭제: generate/page, studio/page, asset-generate-form, prompt-editor, asset-studio, asset-list (6파일)
  - 생성: asset-gallery, asset-card, asset-filter-bar, asset-detail-modal (4파일)
  - 수정: assets/page.tsx (AssetGallery), navigation.ts (Studio 제거), asset-store.ts (selectedAssetId)
  - 프롬프트 프리픽스/네거티브 강화 (tileset/map/object 픽셀아트 제약)
- [x] 오피스 테마 에셋 5개 배치 생성 (ComfyUI, test@example.com 계정)
  - 캐릭터 3개: office_worker_male, office_worker_female, office_manager
  - 타일셋 1개: office_floor_tileset (seamless)
  - 맵 1개: office_building_map
- [x] 에셋 갤러리 401 에러 처리 추가 (미인증 시 안내 메시지)
- [x] 타일셋/맵 v2 재생성 (프롬프트 강화 후) → 픽셀아트 개선 확인

### In Progress (다음 세션)
- [ ] **AI 캐릭터 스프라이트 프레임 정렬 후처리**
  - 문제: AI 생성 128x128 프레임 내 캐릭터 위치/크기 불일치
  - 증상: 게임 적용 시 방향별 머리 짤림 / 하체 짤림
  - 해결: loadCustomAvatarTexture()에서 바운딩박스 감지 → 중앙 정렬 → 32x48 리사이즈
  - 파일: `src/features/space/avatar/internal/sprite-generator.ts` (line 184~247)
- [ ] 타일셋/맵 품질 근본 개선 (모델 통일 + 개별 타일 생성 + 조립 파이프라인)

### Decisions
- 사용자 계정: `test@example.com` (id: cmltb99mb0000tds0j1mb2ms8) — 앞으로 이 계정으로 작업
- 에셋 갤러리: 단일 /assets 페이지로 통합, 생성 폼은 CLI 전용
- 타일셋/맵 모델 이원화 문제 확인: DreamShaper(SD1.5) vs pixelArtDiffusionXL(SDXL)

### Modified Files
- src/components/assets/asset-gallery.tsx (신규)
- src/components/assets/asset-card.tsx (신규)
- src/components/assets/asset-filter-bar.tsx (신규)
- src/components/assets/asset-detail-modal.tsx (신규)
- src/app/assets/page.tsx (수정)
- src/constants/navigation.ts (수정)
- src/stores/asset-store.ts (수정)
- src/features/assets/internal/constants.ts (수정)

### Handoff Notes (다음 세션)
- **최우선**: AI 캐릭터 프레임 정렬 후처리 구현 (sprite-generator.ts)
- 이후: 타일셋/맵 파이프라인 개선 (SDXL 통일 + 개별 타일 생성)

---

## 20:xx - 치비 파이프라인 구현 + 폭 정규화 + IP-Adapter 플랜

### Completed
- [x] 프롬프트/샘플러 개선 4개 파일 수정 (이전 플랜 구현)
  - constants.ts: 64x64→128x128 수정, 일관성 키워드, CHARACTER_GENERATION_DEFAULTS 추가
  - character-sprite.json: dpmpp_2m/karras/steps30/cfg7.5
  - character-controlnet.json: 동일 변경
  - processor.ts: 캐릭터 전용 결정론적 샘플러 override
- [x] 테스트 생성 실행 (office-worker-test, seed=42)
  - **결과 불량**: GRADE=WARN, 가로 크기 64~128px (차이 64px), stddev=20.6px
  - 프롬프트/샘플러 변경만으로는 해결 불가 확인
- [x] 스프라이트시트 품질 분석기 생성 (scripts/analyze-spritesheet.ts)
  - 프레임별 바운딩박스, 크기 편차, 중심 이탈, 점유율 분석
  - PASS/WARN/FAIL 자동 등급
- [x] 강제 검증 매커니즘 메모리에 기록 (Mandatory Enforcement 섹션)
- [x] 치비 캐릭터 파이프라인 설계 완료 (플랜 파일)
  - 모델: Animagine XL 3.1 + Chibi LoRA + OpenPose SDXL ControlNet
  - 방식: 프레임별 개별 생성 (32개) + 배경제거 + 리사이즈 + 합성
  - 7 Phase, 14+ 파일 변경/신규

### In Progress
- [ ] **치비 캐릭터 파이프라인 구현** (플랜 승인 대기)
  - 플랜 파일: `~/.claude/plans/peaceful-booping-bunny.md`
  - 사전 준비: 모델 3개 다운로드 필요 (Animagine XL, Chibi LoRA, OpenPose SDXL)

### Decisions
- **픽셀아트 폐기**: 사용자가 원하는 스타일이 아님 → 치비/SD 스타일로 전환
- **프레임별 생성**: 단일 시트 생성 → 개별 프레임 ControlNet 생성 + 합성으로 변경
- **모델 스택**: Animagine XL 3.1 + ChibiStyleXL v1.1 + OpenPose SDXL (12GB VRAM)
- **프레임 수 유지**: 방향당 8프레임 (총 32개)
- **결과 보고 강제**: analyze-spritesheet.ts 출력 수치만 보고, 주관적 해석 금지

### Modified Files
- src/features/assets/internal/constants.ts (수정: 프롬프트+샘플러)
- src/features/assets/internal/processor.ts (수정: 캐릭터 override)
- comfyui-workflows/character-sprite.json (수정: 노드 기본값)
- comfyui-workflows/character-controlnet.json (수정: 동일)
- scripts/analyze-spritesheet.ts (신규: 품질 분석기)

### Handoff Notes
- ~~다음 세션: 치비 파이프라인 플랜 승인 → 구현 시작~~
- 치비 Phase 1~7 구현 완료, Phase 8 (IP-Adapter) 구현 대기

---

## ~23:xx - 치비 파이프라인 Phase 1~7 구현 + 폭 정규화 완료

### Completed
- [x] 치비 파이프라인 Phase 1~7 전체 구현 (14+ 파일)
- [x] 모델 다운로드: Animagine XL 3.1 (HF), OpenPoseXL2 (HF), yuugiri-lyco LoRA (수동)
- [x] ComfyUI 캐시 방지 (filename_prefix 고유화)
- [x] GPT 피드백 반영: seed 전략, bbox 정규화, 프롬프트 일관성
- [x] normalizeDirectionFrames() 구현: median bbox + fit:fill + 2차 equalization
- [x] 분석기 GRADE: PASS (높이 stddev=0px, 방향 내 폭 range=0px)
- [x] IP-Adapter 플랜 작성 (Phase 8)

### Key Decisions
- **폭 정규화**: fit:fill로 모든 프레임을 동일 크기 강제 리사이즈 + 2차 equalization (bbox 재측정→수평 스케일)
- **alignCharacterFrames 제거**: normalizeDirectionFrames가 이미 중앙+바닥선 처리, 추가 시프트는 클리핑 유발
- **alpha 임계값 일치**: extractBBox alpha>10 (분석기와 동일 기준)
- **IP-Adapter 도입 결정**: ControlNet만으로는 캐릭터 identity 유지 불가 확인

### Modified Files
- src/features/assets/internal/post-processor.ts (핵심: normalizeDirectionFrames + equalization)
- src/features/assets/internal/processor.ts (processChibiCharacterGeneration)
- src/features/assets/internal/constants.ts (CHIBI_* 상수)
- src/features/assets/internal/types.ts (useChibiStyle 등)
- src/features/assets/internal/capability-checker.ts (모델 검출)
- src/features/assets/internal/workflow-loader.ts (chibi 워크플로우 등록)
- src/features/assets/internal/pose-manager.ts (NEW)
- src/features/assets/index.ts (export 추가)
- src/app/api/assets/generate/route.ts (파라미터 전달)
- src/lib/comfyui/client.ts (uploadImage)
- comfyui-workflows/character-chibi-frame.json (NEW)
- comfyui-workflows/character-chibi-fallback.json (NEW)
- comfyui-workflows/poses/*.png (32개, NEW)
- scripts/analyze-spritesheet.ts (NEW)
- scripts/quick-chibi-test.ts (NEW)

### Test Results
```
=== GRADE: PASS ===
BBox Height: avg=112px, stddev=0px
Per-Row: Down=73~73, Left=74~74, Right=91~91, Up=76~76
```

### Handoff Notes
- ~~다음 세션: IP-Adapter 플랜 실행 (Phase 8)~~
- Phase 8 완료 (아래 참조)

---

## 09:xx - IP-Adapter Phase 8 구현 완료

### Completed
- [x] IP-Adapter Phase 8 구현 (8개 파일 수정 + 워크플로우 JSON 수정)
  - workflow-loader.ts: chibi-ipadapter 워크플로우 등록
  - capability-checker.ts: IP-Adapter 검출 (hasIPAdapter, hasIPAdapterPlus, hasCLIPVision, ipAdapterModels)
  - constants.ts: IPADAPTER_DEFAULTS (weight=0.8, weightType="linear")
  - types.ts: ipAdapterWeight 필드
  - processor.ts: 2-Phase 생성 (Phase A 레퍼런스 + Phase B IP-Adapter 주입)
  - route.ts + index.ts: API 연결
  - character-chibi-ipadapter.json: IPAdapterAdvanced + CLIPVisionLoader 구조
- [x] ComfyUI 재시작 (IPAdapter_plus 커스텀 노드 로드)
- [x] 실제 생성 테스트: 32프레임, GRADE: PASS, ~19분
- [x] tsc ✅ vitest 52/52 ✅

### Decisions
- **IPAdapterAdvanced 사용**: IPAdapter Simple은 clip_vision을 직접 받지 않음, IPAdapterUnifiedLoader 필요 → IPAdapterAdvanced가 clip_vision optional로 수용하므로 직접 사용
- **2-Phase 방식**: Phase A(down_0 레퍼런스 1장) → Phase B(32프레임에 reference_image + ipadapter_weight 주입)
- **Graceful Fallback**: IP-Adapter 미설치 시 기존 chibi-frame 워크플로우 자동 사용
- **ComfyUI 포트 변경**: 재시작 후 8001→8000 (.env 업데이트)

### Test Results
```
=== GRADE: PASS ===
BBox Width: avg=112px, stddev=0px, range=0px
BBox Height: avg=112px, stddev=0px, range=0px
4방향 모두 112~112px 균일
생성 시간: 1161초 (~19분)
```

### Handoff Notes
- **치비 파이프라인 Phase 1~8 전부 완료**
- 다음 가능한 작업: 에셋 생성 UI, 타일셋/맵 파이프라인 개선
- ComfyUI 포트 8000 (변경됨)
- IPAdapterAdvanced 사용 (Simple 아님) 주의

---

## ~22:xx - 치비 스프라이트 일관성 분석 + LoRA 학습 플랜

### Completed
- [x] 생성된 치비 프레임 시각적 일관성 검토
  - 결과: 방향 내/방향 간 외형 불일치 확인 (갑옷 디테일, 체형, 색상 밸런스)
  - GRADE: PASS는 크기/정렬만 — 시각적 identity 일관성 미측정
- [x] 해결 방안 논의 → **범용 치비 스타일 LoRA 학습** 결정
- [x] 학습 도구: **kohya_ss** 선택
- [x] 5 Phase 구현 플랜 작성 완료

### Decisions
- **LoRA 학습 결정**: 프레임 간 일관성 확보를 위해 게임 스프라이트 전용 치비 스타일 LoRA 학습
- **kohya_ss**: sd-scripts 기반, RTX 4070 12GB 호환
- **범용 스타일**: 특정 캐릭터가 아닌 치비 스타일 자체 학습
- **yuugiri 대체**: 커스텀 LoRA가 우선, yuugiri는 fallback
- **트리거 워드**: `flowspace_chibi`
- **학습 데이터**: 하이브리드 (AI 선별 20~30 + 오픈소스 10~15)
- **하이퍼파라미터**: dim=32, alpha=16, AdamW8bit, LR=5e-5, 12 epochs

### Modified Files
- 없음 (플래닝만 진행)

### New Files
- `.claude/specs/chibi-pipeline/decisions/2026-02-22-lora-training.md` (결정 문서)
- `~/.claude/plans/fluffy-meandering-hollerith.md` (구현 플랜)

### Handoff Notes (다음 세션)
- **플랜 승인 후 Phase 1부터 실행**: kohya_ss 설치
- 플랜 파일: `~/.claude/plans/fluffy-meandering-hollerith.md`
- 결정 문서: `.claude/specs/chibi-pipeline/decisions/2026-02-22-lora-training.md`
- ComfyUI output에서 학습 데이터 선별 작업 필요 (Phase 2)
- 환경: RTX 4070 12GB, Python 3.12.10, ComfyUI Desktop v0.12.3
