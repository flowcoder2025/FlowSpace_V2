# 2026-02-21

## Session 1 — 배포 준비 + 실사용 버그 수정

### Completed

#### 배포 준비 작업
- [x] Edge Runtime 경고 수정: `auth.config.ts` 분리 (Prisma/bcrypt Edge 번들링 제거)
- [x] 환경변수 정리: `.env.example` 완성 (NEXT_PUBLIC_SOCKET_PORT, COMFYUI_MODE 등)
- [x] Prisma 마이그레이션 초기화: `prisma.config.ts` + `0_init` 베이스라인 (db push → migrate 전환)
- [x] 미디어 관리자 UI: 대시보드 Media 탭 + 스포트라이트 권한 API 2개
- [x] 테스트 프레임워크: Vitest 설정 + chat-parser/chat-filter 52개 단위 테스트
- [x] 배포 환경: Dockerfile (multi-stage standalone) + docker-compose.yml + GitHub Actions CI
- [x] LiveKit 서버 바이너리 설치 (v1.9.11 Windows amd64)

#### 실사용 테스트 버그 수정 (Critical)
- [x] **소켓 인증 실패**: tsx가 .env 미로드 → AUTH_SECRET undefined → `server/index.ts`에 dotenv import 추가
- [x] **Prisma prepared statement 에러**: Supabase PgBouncer 비호환 → DATABASE_URL에 `?pgbouncer=true&connection_limit=1`
- [x] **채팅 메시지 미표시**: chatMsgId 0부터 시작 → 캐시 id 충돌 → `Date.now()` 기반으로 변경
- [x] **채팅 입력 불가 (WASD)**: Phaser 키보드 캡처 충돌 → `clearCaptures()`/`addCapture()` 토글
- [x] **React key 중복 경고**: 시스템 메시지 캐시 제외 + 캐시 로드 시 중복 id 제거
- [x] **채팅 연결 메시지 반복**: `initDoneRef`로 1회 실행 보장
- [x] **미디어 UI 미표시**: LiveKit 미연결 시에도 비활성 컨트롤 표시

#### 채팅 레거시 스타일 포팅
- [x] 반투명 배경 (`bg-black/40 backdrop-blur-sm`) + `border-white/10`
- [x] 드래그 이동 + 리사이즈: `useChatDrag` 훅 포팅 (localStorage 위치/크기 저장)
- [x] Enter 활성화 패턴: 비활성 → Enter → 활성(입력) → Enter → 전송+비활성
- [x] 탭 스타일: 밑줄 → 배경색 강조 (`bg-white/15`)
- [x] 닉네임 색상: `text-primary`/`text-emerald-400` (레거시 동일)
- [x] 입력창: 투명 배경 + 전송 버튼 제거 (Enter만 사용)
- [x] 스크롤바: `chat-scrollbar` CSS (4px 반투명)
- [x] Players + 참가자 패널 통합 (ParticipantPanel 단일화)

### 검증
- `tsc --noEmit` ✅
- `next lint` ✅
- `next build` ✅ (Edge Runtime 경고 0건, standalone 출력)
- `vitest run` ✅ (52/52 통과)
- Playwright E2E ✅ (로그인 → 소켓 연결 → 채팅 전송/표시 → LiveKit 연결)

### Commits
- `2b05fd7` feat: Phase 11 LiveKit 음성/화상 통합 + Edge Runtime 수정
- `4b0106a` feat: 배포 준비 — 환경변수, 마이그레이션, 미디어 관리, 테스트, CI/CD
- `2593b74` fix: 소켓 연결 + 채팅 시스템 + 미디어 UI 전면 수정

### Modified Files (21)
**NEW:**
- `src/lib/auth.config.ts` (Edge 호환 NextAuth 설정)
- `prisma.config.ts` (Prisma 7 대비)
- `prisma/migrations/0_init/migration.sql` (베이스라인)
- `src/app/api/spaces/[id]/admin/media/route.ts`
- `src/app/api/spaces/[id]/admin/media/[grantId]/route.ts`
- `src/app/dashboard/spaces/[id]/media/page.tsx`
- `src/components/dashboard/media-management.tsx`
- `src/features/space/chat/internal/chat-parser.test.ts`
- `src/features/space/chat/internal/chat-filter.test.ts`
- `vitest.config.ts`
- `Dockerfile` + `docker-compose.yml` + `.dockerignore`
- `.github/workflows/ci.yml`
- `src/features/space/hooks/internal/useChatDrag.ts`

**MOD:**
- `server/index.ts` (dotenv 추가)
- `src/middleware.ts` (auth.config import)
- `src/lib/auth.ts` (authConfig spread)
- `src/components/space/chat-panel.tsx` (레거시 스타일 전면 재작성)
- `src/components/space/chat/chat-input-area.tsx` (Enter 패턴 + Phaser 캡처 해결)
- `src/components/space/chat/chat-message-list.tsx` (레거시 스타일)
- `src/components/space/chat/chat-tabs.tsx` (레거시 스타일)
- `src/components/space/video/SpaceMediaLayer.tsx` (Players 통합)
- `src/components/space/video/ParticipantPanel.tsx` (Players 통합)
- `src/features/space/game/internal/player/input-controller.ts` (clearCaptures 토글)
- `src/features/space/socket/internal/socket-client.ts` (싱글턴 정리)
- `src/features/space/chat/internal/use-chat.ts` (initDoneRef, Date.now ID)
- `src/features/space/chat/internal/use-chat-storage.ts` (시스템 메시지 캐시 제외)
- `src/app/space/[id]/space-client.tsx` (chatMsgId Date.now, PlayerList 제거)

### Decisions
- tsx 소켓 서버는 .env 자동 로드 안 함 → dotenv 명시적 import 필수
- React 이벤트 위임 + Phaser 키보드 캡처 충돌 → Phaser clearCaptures/addCapture 토글로 해결
- 메시지 id는 Date.now() 기반 (세션 간 캐시 충돌 방지)
- auth.config.ts 분리로 Edge Runtime 경고 해결 (NextAuth v5 권장 패턴)

### Handoff Notes
- 개발서버: `npm run dev:all` (Next.js 3000 + Socket.io 3001 + LiveKit 7880)
- LiveKit 바이너리: `bin/livekit-server.exe` v1.9.11 (gitignore됨, 수동 설치 필요)
- 남은 작업: 에디터 명령어 연동, 브라우저 알림, 모바일 반응형, 프로덕션 배포

---

## Session 2 — ComfyUI KSampler [Errno 22] 디버깅

### 문제
- ComfyUI Desktop (Electron) + Windows에서 KSampler 실행 시 `OSError: [Errno 22] Invalid argument`
- tqdm progress bar가 stderr에 쓸 때 Windows Electron의 broken stderr pipe에서 에러 발생

### 디버깅 과정
1. ~~aimdo_allocator 문제~~ → 아님
2. ~~ComfyUI-Manager prestartup_script.py wrapper_stderr~~ → 패치했으나 .pyc 캐시/다중 파일 위치 문제
3. ~~logger.py write/flush try/except~~ → `io.TextIOWrapper`는 C 확장 immutable type, 메서드 교체 불가
4. ~~tqdm/std.py fp_write 패치~~ → 동일 .pyc 캐시 문제
5. ~~sitecustomize.py로 io.TextIOWrapper.write 교체~~ → `TypeError: cannot set 'write' attribute of immutable type`
6. **최종 해결**: `sitecustomize.py`에 `TQDM_DISABLE=1` 환경변수 설정

### 핵심 발견
- ComfyUI-Manager의 `prestartup_script.py`는 **3곳**에 존재:
  - `custom_nodes/ComfyUI-Manager/` (git repo)
  - `.venv/Lib/site-packages/comfyui_manager/` (pip 설치)
  - `AppData/Local/uv/cache/` (uv 캐시)
- 실제 로드 위치: `custom_nodes/` (exec_module로 로드)
- `io.TextIOWrapper`는 C 확장 타입이라 Python에서 write/flush 메서드 교체 불가
- 공식 수정: [PR #2462](https://github.com/Comfy-Org/ComfyUI-Manager/pull/2462) (MERGED, flush만), [PR #11629](https://github.com/Comfy-Org/ComfyUI/pull/11629) (OPEN)

### 수정된 파일 (ComfyUI 외부)
- `C:\Users\User\ComfyUI\.venv\Lib\site-packages\sitecustomize.py` — NEW (TQDM_DISABLE=1)
- `C:\Users\User\AppData\Local\Programs\ComfyUI\resources\ComfyUI\app\logger.py` — flush try/except
- `C:\Users\User\ComfyUI\custom_nodes\ComfyUI-Manager\prestartup_script.py` — write_stderr try/except
- `C:\Users\User\ComfyUI\.venv\Lib\site-packages\comfyui_manager\prestartup_script.py` — _safe_write
- `C:\Users\User\ComfyUI\.venv\Lib\site-packages\tqdm\std.py` — fp_write try/except
- `C:\Users\User\AppData\Local\Programs\ComfyUI\resources\ComfyUI\comfy\utils.py` — model_trange try/except

### 현재 상태
- **ComfyUI KSampler 정상 동작 확인 (Errno 22 해결)**
- 모델 2개 사용 가능: `DreamShaper_8_pruned.safetensors`, `pixelArtDiffusionXL_spriteShaper.safetensors`
- ComfyUI API: `http://localhost:8001` (Electron Desktop, v0.14.1)
- 구버전 포트 8000 프로세스 (2/9 시작, v0.12.2) 종료 완료

### 해결 요약
- `sitecustomize.py`에 `TQDM_DISABLE=1` + ComfyUI Desktop 재시작으로 해결
- 포트 8000 (수동 실행, 2/9)은 수정 전 프로세스여서 에러 지속 → 종료
- 포트 8001 (Electron Desktop, 오늘 시작)은 sitecustomize.py 로드되어 정상 동작
- v0.14.1의 `model_trange`에도 OSError try/except 내장 (이중 보호)

### Handoff
- ComfyUI KSampler 정상 → FlowSpace API 연동 진행 가능
- ComfyUI API: `http://localhost:8001`

---

## Session 3 — 파츠 조합 캐릭터 시스템 (Phase 1~3 전체 구현)

### Completed

#### Phase 1: Core Engine (Task 1-4)
- [x] Task 1: 해상도 업그레이드 (24x32 → 32x48) — game-constants, sprite-generator, local-player, remote-player-sprite
- [x] Task 2: 파츠 타입 시스템 + 문자열 파싱 — parts-types, parts-string, parts-registry, avatar-types, avatar-config
- [x] Task 3: 컴포지터 + body/eyes 드로어 — parts-compositor, drawer-utils, body-drawer, eyes-drawer
- [x] Task 4: 나머지 드로어 + 통합 — hair/top/bottom/accessory-drawer, avatar index.ts public API

#### Phase 2: 커스터마이징 UI (Task 5-8)
- [x] Task 5-6: 캐릭터 에디터 컴포넌트 — character-editor, category-tabs, part-grid, color-picker, skin-tone-picker, preview-canvas
- [x] Task 7: 온보딩 + API 통합 — onboarding-form, users/me API, space page avatar 전달
- [x] Task 8: 디폴트 아바타 + 폴백 — classic/custom/parts 공존, parseAvatarString 폴백

#### Phase 3: 인게임 연동 (Task 9-11)
- [x] Task 9: 런타임 아바타 스왑 — local-player.updateAvatar(), remote-player-sprite.updateAvatar()
- [x] Task 10: 소켓 아바타 브로드캐스트 — socket types, use-socket, use-socket-bridge, server/handlers/avatar
- [x] Task 11: 인게임 아바타 에디터 모달 — avatar-editor-modal, space-client HUD 버튼

#### 채팅 린트 수정
- [x] chat-panel.tsx: isActiveRef.current 렌더 중 할당 → useEffect 이동
- [x] chat-input-area.tsx: onEscape useCallback 의존성 추가, 미사용 TAB_RING_COLOR 제거

### 검증
- `tsc --noEmit` ✅
- `next lint` ✅
- `next build` ✅

### Commits (pushed to origin/main)
- `06dca17` feat: ComfyUI 워크플로우 개선 및 오브젝트 생성 추가
- `3e5a36f` feat: 파츠 조합 캐릭터 시스템 Core Engine
- `7c8d913` feat: 캐릭터 에디터 UI + 온보딩 통합
- `0cfb0c8` feat: 인게임 아바타 연동 — 런타임 스왑 + 소켓 브로드캐스트 + 에디터 모달
- `87ae0fe` fix: 채팅 lint 에러 수정 + 프로젝트 메모리 업데이트

### 신규 파일 (30+)
**Parts Engine:**
- `src/features/space/avatar/internal/parts/parts-types.ts`
- `src/features/space/avatar/internal/parts/parts-string.ts`
- `src/features/space/avatar/internal/parts/parts-registry.ts`
- `src/features/space/avatar/internal/parts/parts-compositor.ts`
- `src/features/space/avatar/internal/parts/drawers/drawer-utils.ts`
- `src/features/space/avatar/internal/parts/drawers/body-drawer.ts`
- `src/features/space/avatar/internal/parts/drawers/eyes-drawer.ts`
- `src/features/space/avatar/internal/parts/drawers/hair-drawer.ts`
- `src/features/space/avatar/internal/parts/drawers/top-drawer.ts`
- `src/features/space/avatar/internal/parts/drawers/bottom-drawer.ts`
- `src/features/space/avatar/internal/parts/drawers/accessory-drawer.ts`

**Editor UI:**
- `src/components/avatar/index.ts`
- `src/components/avatar/character-editor.tsx`
- `src/components/avatar/internal/category-tabs.tsx`
- `src/components/avatar/internal/part-grid.tsx`
- `src/components/avatar/internal/color-picker.tsx`
- `src/components/avatar/internal/skin-tone-picker.tsx`
- `src/components/avatar/internal/preview-canvas.tsx`
- `src/components/space/avatar-editor-modal.tsx`

**Server:**
- `server/handlers/avatar.ts`

### 수정된 파일 (15+)
- `src/constants/game-constants.ts` (PLAYER_WIDTH 24→32, PLAYER_HEIGHT 32→48)
- `src/features/space/avatar/internal/avatar-types.ts` (PartsAvatarConfig 추가)
- `src/features/space/avatar/internal/avatar-config.ts` (parts: 파싱, DEFAULT_PARTS_AVATAR)
- `src/features/space/avatar/internal/sprite-generator.ts` (32x48 + generateAvatarSpriteFromConfig)
- `src/features/space/avatar/index.ts` (public API 확장)
- `src/features/space/game/events/types.ts` (PLAYER_AVATAR_UPDATED, REMOTE_PLAYER_AVATAR_UPDATED)
- `src/features/space/game/internal/player/local-player.ts` (updateAvatar, 32x48 offset)
- `src/features/space/game/internal/remote/remote-player-sprite.ts` (updateAvatar, 32x48)
- `src/features/space/game/internal/remote/remote-player-manager.ts` (avatarUpdated 이벤트)
- `src/features/space/game/internal/scenes/main-scene.ts` (PLAYER_AVATAR_UPDATED 리스너)
- `src/features/space/socket/internal/types.ts` (avatar:update, player:avatar-updated)
- `src/features/space/socket/internal/use-socket.ts` (sendAvatarUpdate)
- `src/features/space/bridge/internal/use-socket-bridge.ts` (avatar diff + sendAvatarUpdate)
- `server/index.ts` (handleAvatar 등록)
- `src/components/auth/onboarding-form.tsx` (CharacterEditor 교체)
- `src/app/api/users/me/route.ts` (avatarConfig 검증)
- `src/app/space/[id]/page.tsx` (avatarConfig 전달)
- `src/app/space/[id]/space-client.tsx` (에디터 모달 + sendAvatarUpdate)
- `src/components/space/chat-panel.tsx` (ref 린트 수정)
- `src/components/space/chat/chat-input-area.tsx` (의존성 + 미사용 변수 수정)

### 설계 결정
- 32x48 해상도: ZEP 비율, 32px 타일 정합
- Canvas 2D 프로시저럴 드로잉: 외부 에셋 불필요, 즉시 구현
- 레이어 순서: body → bottom → top → eyes → hair → accessory
- 3종 아바타 공존: classic: / custom: / parts: (하위 호환)
- 조합 수: 3×6×4×6×4×5 = 8,640 기본 (색상 포함 무한)
- DB: 기존 User.avatarConfig (Json?) 재사용 (마이그레이션 불필요)
- UI: React 독립 프리뷰 (Phaser 의존 없음)

### Handoff Notes
- 다음 작업 (마이너 보강):
  1. seed 데이터 업데이트: `prisma/seed.ts` 레거시 `{ color: "#3B82F6" }` → parts 포맷
  2. E2E 수동 검증: 온보딩 → 스페이스 입장 → 아바타 표시
  3. 기존 유저 마이그레이션 폴백 확인: DB 레거시 `{ color: ... }` 유저 정상 동작
- 이후 작업: ComfyUI 파이프라인 개선 (별도 Epic)
