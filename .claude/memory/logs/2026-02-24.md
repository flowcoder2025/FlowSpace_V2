# 2026-02-24 Daily Log

## 19:00 - Session Save (기술 리서치 — 3D→2D→치비 파이프라인 확정)

### Completed
- [x] 외부 "치비 스프라이트 가이드" 3개 문서 기술 검토
  - 1차: "99% 성공률" 가이드 — SD1.5 ControlNet + SDXL 호환 오류, 비현실적 수치
  - 2차: 반박문 — img2img + 이중 IPAdapter 제안, 우리 실측과 모순
  - 3차: Two Pass img2img 제안 — 수학적으로 원본 보존율 15% (txt2img와 동일)
  - **결론**: 3개 모두 AI 생성 문서, 실측 근거 없음
- [x] 유튜브 영상 분석 ("AI 게임 개발 어디까지 왔나" — P5QqZ1hjYKQ)
  - 픽셀 아트 스프라이트시트: 저해상도(32~64px)라 일관성 문제 안 보임
  - 고품질 결과를 내는 튜토리얼은 3D 중간 단계 사용 (TawusGames 확인)
- [x] 웹 리서치: 실제 작동하는 스프라이트 파이프라인 조사
  - TawusGames: Hunyuan 3D → 리깅 → Depth/Pose 추출 → ControlNet 2D 생성
  - 순수 txt2img/img2img로 4방향 일관성 해결한 검증 사례 없음

### Decisions
- **일반 인간형→3D→치비화 파이프라인 확정**: 사용자 제안
  - 기존: 치비 직접 3D 변환 (왜곡 우려)
  - 변경: 일반 인간형 → Trellis2 3D → 4방향 렌더링 → img2img 치비화
  - 이유: 3D 모델은 일반 인체 비율에 최적화, 치비화는 "스타일 변환"이라 img2img 적합
- **핵심 인사이트**: 방향 전환(구조 변경)은 img2img 불가, 스타일 변환(구도 유지)은 img2img 가능

### Key Findings
- **픽셀 아트 vs 애니 치비**: 32px 픽셀 아트는 일관성 차이가 안 보여서 "성공"처럼 보임. 1024px 애니 치비는 미세 차이도 눈에 띔
- **3D 중간 파이프라인이 정답**: 유튜브/튜토리얼에서 실제 일관성 있는 결과는 전부 3D 경유
- **외부 AI 가이드 신뢰성 낮음**: "99% 성공률", "실측 데이터" 주장하나 스크린샷/증거 없음

### Modified Files (프로젝트)
- `.claude/specs/_index.md` — Phase 12 방향 업데이트

### Handoff Notes
- **다음 세션 최우선**: 3D→2D→치비 파이프라인 구현 시작
  1. Trellis2 / Hunyuan 3D 설치 + 테스트
  2. 일반 인간형 캐릭터 정면 1장 생성
  3. 3D 변환 → 4방향 렌더링
  4. img2img + chibi LoRA로 치비화
- ComfyUI: port 8000
- 선택지: A) Trellis2 (ComfyUI 노드) / B) Hunyuan 3D (웹/API) / C) 픽셀 아트 스타일 전환

## 15:00 - Session Save (LoRA v2 + txt2img 접근 실패 확정 → Trellis2 전환)

### Completed
- [x] LoRA v2 strength 조정 테스트 (epoch 8 + str 0.7/0.5)
  - str=0.7: 실루엣 문제 해결 (`anime coloring` + 강화 네거티브)
  - str=0.5: 너무 약함 (성별 변환, 비율 깨짐)
  - **str=0.7이 실루엣 해결에 최적**, 하지만 방향 간 색상 불일치 여전
- [x] 기존 학습 데이터 45장 전수 감사 — **18장(40%) 불량**
  - 공통 패턴: back 실루엣/어두움, side 머리색/의상색 변경
- [x] 불량 이미지 재생성 3라운드 (1차 26장, 2차 12장, 3차 3장)
  - c03/c05/c08/c10/c11 개선 성공
  - c01/c06 등 여전히 불일치
- [x] 캐릭터별 LoRA용 39장 큐레이션 → **최종 일관성 검증 FAIL**
  - c01: 머리스타일/비율/정장색 전부 다름 (front vs side vs back)
  - c06: 머리스타일/눈색/티셔츠색/백팩색 전부 다름
  - c09: 유일하게 OK (셰프모자+흰유니폼 = 특징적 아이템이 일관)
- [x] **근본 한계 확정: txt2img는 "같은 캐릭터의 다른 방향"을 보장 불가**

### Decisions (최종)
- **txt2img 기반 학습 데이터 생성 접근 폐기**: 매 생성마다 머리/색상/비율 랜덤 → 일관성 확보 불가
- **per-character LoRA 보류**: 학습 데이터 자체를 확보할 수 없으므로 학습 의미 없음
- **Trellis2 3D 파이프라인으로 전환 결정**: 정면 1장 → 3D → 4방향 렌더링 = 기하학적 일관성 보장
- **고정 프리셋 캐릭터 확정**: 11캐릭터 고정, 범용 파이프라인 불필요

### 핵심 교훈 (중요)
- **txt2img 캐릭터 일관성 한계**: 동일 프롬프트라도 seed마다 머리스타일/색상/비율 다름. 검증 수백 장 중 일관된 세트는 거의 없음
- **"밝다" ≠ "일관적"**: 실루엣 해결과 캐릭터 일관성은 별개 문제. 실루엣 없어도 다른 캐릭터로 보이면 학습 데이터로 부적합
- **상용 2D 메타버스는 전부 수작업 에셋**: Gather/ZEP/메이플 = 디자이너가 그린 것. AI로 방향 일관성 해결한 상용 사례 거의 없음
- **문제 원인 추적 시 "가능한가?" 먼저 판단**: txt2img 한계를 더 일찍 인식했으면 LoRA/재생성에 시간 낭비 안 했을 것

### Modified Files (프로젝트 외부)
- `sd-scripts/train_data/chibi_v2_per_char/` — 캐릭터별 폴더 39장 (사용 안 함)
- `ComfyUI/output/regen/` — 1차 재생성 26장
- `ComfyUI/output/regen2/` — 2차 재생성 12장
- `ComfyUI/output/regen3/` — 3차 재생성 3장
- `ComfyUI/output/test_v2_adj/` — strength 조정 테스트 18장

### Modified Files (프로젝트)
- `scripts/regenerate-bad-images.py` — 1차 재생성 스크립트 (신규)
- `scripts/regenerate-round2.py` — 2차 재생성 스크립트 (신규)
- `scripts/curate-chibi-v2.py` — per-character 큐레이션 (수정)
- `.claude/specs/_index.md` — Phase 12 Trellis2 검증 예정으로 업데이트

### Handoff Notes
- **다음 세션 최우선**: Trellis2 3D 파이프라인 검증 (30분 빠른 테스트)
  - ComfyUI-TRELLIS2 노드 설치
  - 이미 잘 나온 치비 정면 1장으로 2D→3D 변환 테스트
  - 성공 시: 11캐릭터 정면만 잘 만들면 끝
  - 실패 시: AI 정면 + 수동 편집 or 외주
- ComfyUI: 실행 중 (port 8000)
- LoRA v2 (epoch 8): ComfyUI에 배포됨 (사용 여부는 Trellis2 결과 후 결정)

---

## 13:30 - Session Save (LoRA v2 학습 완료 + 검증 진행 중)

### Completed
- [x] Phase 1: 학습 데이터 126장 생성 (11캐릭터 × 3방향 × 다중 시드)
  - 실루엣 문제 발견 → `anime coloring, clean lineart` + 네거티브 보강으로 해결
  - 3차 시도(v3)에서 성공적인 프롬프트 발견
- [x] Phase 2: 45장 큐레이션 + 캡션 생성 (정면17/측면14/후면14)
- [x] Phase 3: 정규화 이미지 50장 생성 (일반 애니메)
- [x] Phase 4: LoRA 학습 실행 (20:37 시작 → 08:30 완료, 약 12시간)
  - sd-scripts 옵션 호환성 3건 수정
  - 4개 체크포인트: epoch 2/4/6/8

### In Progress
- [ ] Phase 5: 검증
  - Current: epoch 8 (strength=1.0) 테스트 완료 → **실루엣 문제 발견**
  - 기사(knight)만 정상, 오피스/캐주얼은 얼굴/몸통이 검은색
  - Next: strength 0.5~0.7 + `anime coloring` 프롬프트 보정 테스트
  - Next: 안 되면 epoch 4/6 체크포인트 비교, 또는 학습 데이터 재큐레이션

### Decisions
- 측면 프롬프트: `from_side` + `anime coloring, clean lineart` (profile, facing left 제거)
- 네거티브: `silhouette, shadow, dark, backlighting, monochrome, greyscale` 추가
- sd-scripts: `--network_train_unet_only` (구 --train_unet_only), caption_dropout_rate 제거

### Key Issue: LoRA v2 실루엣 학습 문제
- **증상**: strength=1.0에서 오피스/캐주얼 캐릭터가 실루엣/어두운 스타일
- **원인 추정**: 학습 데이터 45장 중 c01-c07 원본 후면(_a/_b)이 어두웠음
  - c05_back_b: 전체적으로 어두운 톤
  - 일부 정면도 강한 대비
  - 이 어두운 패턴이 LoRA에 "스타일"로 학습됨
- **기사(c10)만 정상인 이유**: fix 버전(_c/_d)으로 밝은 은갑옷+빨간 망토
- **다음 시도 순서**:
  1. strength 0.5~0.7 + anime coloring 프롬프트 보정
  2. epoch 4/6 체크포인트 비교 (언더피팅이 오히려 나을 수 있음)
  3. 학습 데이터 재큐레이션 (어두운 이미지 교체)
  4. 학습 재실행 (최후수단)

### Modified Files (프로젝트 외부)
- `sd-scripts/train_config.toml` — chibi_v2 경로, reg_v2 경로
- `sd-scripts/train_lora.sh` — v2 output, 8 epochs, UTF-8 설정, 옵션 수정
- `sd-scripts/output/flowspace-chibi-v2*.safetensors` — 4개 체크포인트
- `sd-scripts/train_data/chibi_v2/10_flowspace_chibi/` — 학습 데이터 45장+캡션

### Handoff Notes
- ComfyUI: 실행 중 (port 8000)
- `scripts/test-lora-v2-adjusted.py` — 작성 완료, 아직 실행 안 함
- 이 스크립트가 strength 0.7/0.5로 테스트 (anime coloring + 강화 네거티브)
- 실행 후 결과 확인하여 strength 결정 필요
