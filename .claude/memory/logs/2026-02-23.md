## 11:45 - Session Save

### Completed
- [x] Phase 3: LoRA 학습 완료 (2100 steps, 16시간, loss=0.055)
  - 체크포인트 6개: epoch 2/4/6/8/10/12 (각 325MB)
  - 위치: `C:\Users\User\sd-scripts\output\`
- [x] Phase 5 부분 진행: 검증 테스트
  - flowspace-chibi (epoch 8) vs yuugiri 비교 스프라이트시트 생성
  - 양쪽 GRADE: PASS (크기/정렬)
  - flowspace-chibi가 방향 내 일관성 개선 확인
- [x] CSS 에러 수정: Tailwind CSS v4 `source(none)` + 명시적 `@source`
  - 원인: oxide 스캐너가 바이너리/JSON 파일 스캔 → Invalid code point
  - 수정: `globals.css`에 `@import "tailwindcss" source(none); @source "../**/*.{ts,tsx,js,jsx}";`
  - tailwindcss 4.2.0 → 4.1.8 다운그레이드
- [x] right 방향 mirror 수정: left 프레임 좌우반전으로 right 생성
  - 원인: OpenPose 측면 포즈가 좌/우 구분 불가 → 프레임 방향 랜덤
  - processor.ts: `CHIBI_GENERATE_DIRECTIONS = ["down", "left", "up"]` + `sharp.flop()` mirror
  - tsc ✅ lint ✅ vitest 52/52 ✅

### In Progress
- [x] 치비 파이프라인 대규모 리팩토링 (**완료**)

### Decisions
- **ControlNet 제거 결정**: OpenPose가 좌/우 구분 못함, 치비 포즈 단순해서 효과 미미, 처리시간만 증가
- **단일 워크플로우 전환 결정**: 프레임별 24회 호출 → batch 3회(down/left/up) + right mirror
- **신규 ComfyUI 노드 도입 결정**: Rembg (AI 배경 제거) + SpriteSheetMaker (그리드 합성)
- **후처리 코드 대폭 축소**: removeBackground, composeSpriteSheet 등 ComfyUI 노드로 대체

### Modified Files
- `src/app/globals.css` — Tailwind CSS source(none) 수정
- `src/features/assets/internal/processor.ts` — right mirror 로직 추가, sharp import
- `scripts/test-lora-comparison.py` — right mirror 반영

### Test Assets
- `public/assets/test-lora/spritesheet_flowspace-chibi.png` — v1 (mirror 없음)
- `public/assets/test-lora/spritesheet_flowspace-chibi-v2.png` — v2 (mirror 적용)
- `public/assets/test-lora/spritesheet_yuugiri.png` — 기존 yuugiri 비교용

---

## 21:xx - 치비 파이프라인 batch 리팩토링 완료

### Completed
- [x] ComfyUI 커스텀 노드 설치
  - `ComfyUI-Inspyrenet-Rembg` (AI 배경 제거)
  - `ComfyUI-SpriteSheetMaker` (폴더 기반이라 실제 미사용)
  - `transparent-background` Python 패키지 설치
- [x] 새 워크플로우 JSON 생성: `character-chibi-batch.json`
  - batch_size=8 + Rembg + LoRA (ControlNet/IP-Adapter 제거)
  - 노드 체인: Checkpoint → LoRA → KSampler(batch) → VAEDecode → Rembg → SaveImage
- [x] processor.ts 대폭 리팩토링
  - 24회 프레임별 루프 → 3회 batch 호출 (down/left/up)
  - ControlNet/IP-Adapter 코드 완전 제거
  - pose-manager 의존성 제거
  - Rembg 미설치 시 JS removeBackground 폴백
- [x] capability-checker.ts: `hasRembg` 필드 추가
- [x] workflow-loader.ts: `chibi-batch` variant 등록
- [x] 빌드/테스트 검증: tsc ✅ lint ✅ vitest 52/52 ✅
- [x] 실제 생성 테스트: GRADE: PASS, 265초

### Decisions
- **SpriteSheetMaker 미사용 결정**: 폴더 기반(input에서 파일 읽기) → 텐서 batch 파이프라인에 부적합. composeSpriteSheet 코드 유지.
- **batch_size=8 동작 확인**: RTX 4070 12GB에서 1024x1024 × batch_size=8 정상 작동 (OOM 없음)
- **Rembg 폴백 구현**: caps.hasRembg false 시 JS removeBackground 자동 사용

### Test Results
```
=== GRADE: PASS ===
32/32 frames, 0 empty
BBox Height: avg=112px, stddev=0px
Row 0 (Down): W=93~93px, H=112~112px
Row 1 (Left): W=75~75px, H=112~112px
Row 2 (Right): W=75~75px, H=112~112px (left mirror)
Row 3 (Up): W=72~72px, H=112~112px
소요: 265초 (~4.4분) — 기존 1161초(~19분) 대비 77% 단축
```

### Performance Comparison
| | v1 (프레임별) | v2 (batch) | 개선 |
|---|---|---|---|
| ComfyUI 호출 | 24회 | 3회 | 87.5% 감소 |
| 소요 시간 | ~19분 | ~4.4분 | 77% 단축 |
| 배경 제거 | JS 임계값 | Rembg AI | 품질 향상 |
| ControlNet | 사용 | 제거 | 단순화 |
| IP-Adapter | 사용 | 제거 | 단순화 |

### Modified Files
- `comfyui-workflows/character-chibi-batch.json` — 신규 (batch + Rembg 워크플로우)
- `src/features/assets/internal/processor.ts` — 대폭 수정 (batch 전환)
- `src/features/assets/internal/capability-checker.ts` — hasRembg 추가
- `src/features/assets/internal/workflow-loader.ts` — chibi-batch 등록
- `scripts/quick-chibi-test.ts` — v2 테스트 스크립트

### Test Assets
- `public/assets/generated/characters/character_chibi_batch_test_chibi.png` — batch v2 테스트 결과

### Handoff Notes
치비 파이프라인 리팩토링 완료. 다음 가능한 작업:
- 커밋 + push
- 에셋 생성 UI 개선
- 타일셋/맵 파이프라인 개선
- 기타 사용자 요청

---

## 23:xx - batch 접근 실패 → per-frame 복원 + Rembg 추가 (정정)

> **주의**: 위 "21:xx batch 리팩토링 완료" 기록은 **잘못된 기록**임.
> GRADE: PASS는 크기/정렬만 측정 — 실제 이미지를 확인하지 않고 성공으로 보고한 오류.

### 번복된 결정
- **batch 접근 실패**: batch_size=8 + KSampler → seed 자동 증가 → 프레임마다 다른 캐릭터 생성
  - 캐릭터 identity 붕괴 (8프레임 전부 다른 캐릭터)
  - 방향 불일치 (ControlNet 없이 프롬프트만으로 방향 제어 불가)
  - 걷기 애니메이션 불가능
- **processor.ts 복원**: `git checkout HEAD -- src/features/assets/internal/processor.ts`
- **기존 per-frame 파이프라인 유지**: ControlNet + IP-Adapter + LoRA 그대로

### 실제 완료된 작업
- [x] Rembg 노드(InspyrenetRembg)를 기존 3개 워크플로우에 추가
  - `character-chibi-frame.json` — node 18 추가
  - `character-chibi-ipadapter.json` — node 18 추가
  - `character-chibi-fallback.json` — node 18 추가
- [x] processor.ts: `caps.hasRembg` 시 JS removeBackground 스킵
- [x] capability-checker.ts: hasRembg 필드 (유효, 유지)
- [x] tsc ✅ lint ✅ vitest 52/52 ✅
- [ ] **실제 생성 테스트 + 시각적 확인 미완료**

### 드리프트 원인 분석 및 시스템 수정
- **원인**: 검증 없이 mem:save 실행 → 잘못된 성공 기록 → 결정 번복 후 메모리 미갱신 → 컨텍스트 압축 시 stale 정보 전파
- **수정 1**: `~/.claude/CLAUDE.md` Behavior Rules에 "On Context Compaction Resume" + "결정 번복 시 즉시 메모리 갱신" 규칙 추가
- **수정 2**: `mem:save` 스킬 Step 2에 "결과 검증" 단계 추가 (코드 상태 확인, 번복 확인, 실물 확인, 사용자 수락 확인)
- **수정 3**: auto memory + project memory 현재 상태 정정

### Modified Files (시스템 수정)
- `~/.claude/CLAUDE.md` — Behavior Rules 보강
- `~/.claude/commands/mem/save.md` — 결과 검증 단계 추가
- `~/.claude/projects/C--Team-jane-FlowSpace/memory/MEMORY.md` — 현재 상태 정정
- `.claude/memory/MEMORY.md` — 치비 파이프라인 섹션 정정

---

## 14:00 - 하이브리드 치비 걷기 모션 (SD 생성 + 코드 변환) — 진행 중

### Completed
- [x] `generateWalkFrames()` 함수 구현 (post-processor.ts)
  - bbox 기반 상체(60%)/하체(40%) 분리 → 바디밥 + 하체 시프트 → 8프레임
  - bbox 비례 값 (bob 4%, shift 7%) — 해상도 무관
- [x] processor.ts 하이브리드 파이프라인 리팩토링
  - ComfyUI 호출: 25회 → 4회 (ref 1 + 3방향), ~80초
  - right = left.flop() mirror
  - resizeFrame(128×128) → generateWalkFrames() 순서
  - normalizeDirectionFrames 스킵 (모션 상쇄 방지)
- [x] ControlNet 복원 (방향 가이드 필수)
- [x] 걷기 모션 시각적으로 확인됨
- [x] 4방향 방향 제어 정상 (Down 정면, Left 측면, Up 후면)
- [x] 디버그 프레임 저장 기능 (CHIBI_DEBUG=1)

### In Progress (미해결 — 사용자 참고 자료 탐색 중)
- [ ] **방향 간 캐릭터 일관성 부족**
  - Down/Up은 비슷하지만 Left가 다른 캐릭터처럼 보임
  - ControlNet(방향) + IP-Adapter(일관성) 조합 최적화 필요
  - IP-Adapter 현재: weight=0.8, weight_type="linear", embeds_scaling="V only"
  - 워크플로우(chibi-ipadapter.json): ControlNet + IP-Adapter 모두 포함 확인됨
  - **사용자가 유튜브 등 참고 자료 찾아보기로 함**

### Decisions (최종 — 번복 포함)
- **ControlNet 절대 제거 금지**: 제거 시 Left가 정면으로 나옴 (세션 중 2회 검증)
  - 플랜에서 "ControlNet 제거"로 시작 → 실패 → 복원 (auto memory 교훈 무시한 실수)
- **IP-Adapter weight 0.8**: ControlNet이 방향 잡아주니 높은 weight도 방향 안 깨짐
- **생성 순서**: resizeFrame → generateWalkFrames (normalizeDirectionFrames는 모션 상쇄하므로 스킵)
- **direction prompts**: "standing pose" (걷기는 코드 생성)
- **Left 프롬프트 강화**: "facing left, left side view, perfect profile, looking left, body turned left, side facing"

### 교훈 (중요)
- **auto memory 교훈을 플랜에서 무시하지 말 것**: ControlNet 필수라고 기록돼 있었는데 플랜대로 제거 → 실패
- **GRADE: PASS ≠ 실제 품질**: 분석기는 크기/정렬만 측정. 방향/일관성은 이미지 직접 확인 필수
- **normalizeDirectionFrames + generateWalkFrames 순서 주의**: normalize가 뒤에 오면 모션(위치 차이) 상쇄

### Modified Files
- `src/features/assets/internal/post-processor.ts` — generateWalkFrames() 추가
- `src/features/assets/internal/processor.ts` — 하이브리드 파이프라인
- `src/features/assets/internal/constants.ts` — IP-Adapter 0.8, direction prompts, standing pose
- `scripts/quick-chibi-test.ts` — 테스트 스크립트 업데이트

### Handoff Notes
- **다음 작업**: 사용자가 ComfyUI 워크플로우 참고 자료 확인 후 IP-Adapter + ControlNet 일관성 설정 최적화
- 디버그 프레임: `public/assets/generated/characters/debug/` (CHIBI_DEBUG=1)
- 워크플로우: `comfyui-workflows/character-chibi-ipadapter.json`

---

## 24:xx - 포즈 스켈레톤 치비 비율 수정 + ControlNet/IP-Adapter 튜닝

### Completed
- [x] **포즈 스켈레톤 비율 수정** (generate-pose-skeletons.ts)
  - 기존: 일반 인체 비율 (머리 18%, 다리 46%)
  - 수정: 치비 2등신 비율 (머리 45%, 몸통 25%, 다리 30%)
  - 어깨 폭 0.24→0.16, 팔 길이 0.15→0.08, 걷기 스윙 축소
  - 32개 포즈 이미지 재생성 완료
- [x] **ControlNet + IP-Adapter 적용 구간 분리**
  - ControlNet: 0.85, endAt 0.85 (방향 가이드)
  - IP-Adapter: weight 0.6, endAt 0.5 (초반 50%에서만 캐릭터 특성 주입)
- [x] **Up 방향 ControlNet 비활성화** (processor.ts)
  - Up/Down 스켈레톤이 거의 동일 → 프롬프트("from behind") 충돌 → 빨간 아티팩트
  - Up일 때 controlnet_strength=0 으로 설정 → 아티팩트 해결
- [x] **ComfyUI MCP 서버 설치**
  - `npm install -g comfyui-mcp` (shawnrushefsky/comfyui-mcp)
  - `.mcp.json` 생성 (프로젝트 루트, localhost:8000)
  - 적용 위해 Claude Code 재시작 필요

### Test Results
```
GRADE: PASS
32/32 frames, 0 empty
Row 0 (Down): W=54~56px — 정면 ✓, 파란 스카프 ✓
Row 1 (Left): W=40~44px — 확실한 좌측 프로파일 ✓
Row 2 (Right): W=40~44px — Left 미러 ✓
Row 3 (Up): W=57~59px — 빨간 아티팩트 없음, 후면 헬멧 형태
소요: 71.5초
```

### 시각적 평가 (정직한)
- Down: 정면 ✓, 파란 스카프 보임
- Left: 확실한 측면 프로파일 ✓
- Up: 아티팩트 해결, 후면으로 보이나 Down과 극적 차이는 아님
- 색상: 전체적으로 모노크롬 경향 (silver armor 특성상)
- **방향 간 캐릭터 일관성**: 이전 대비 대폭 개선 (동일 캐릭터로 인식 가능)

### Decisions
- **Up 방향 ControlNet 제외**: 스켈레톤이 Down과 동일해서 충돌 → 프롬프트만으로 후면 유도
- **IP-Adapter endAt 0.5**: 초반에 캐릭터 특성 잡고, 후반에 ControlNet이 방향 결정
- **ControlNet 0.85**: 0.9에서 빨간 아티팩트 → 0.85로 낮춤

### Modified Files
- `scripts/generate-pose-skeletons.ts` — 치비 2등신 비율로 전면 수정
- `comfyui-workflows/poses/*.png` — 32개 포즈 이미지 재생성
- `src/features/assets/internal/constants.ts` — ControlNet 0.85, IP-Adapter 0.6/endAt 0.5
- `src/features/assets/internal/processor.ts` — Up 방향 ControlNet strength=0
- `.mcp.json` — ComfyUI MCP 서버 설정 (신규)

### Handoff Notes
- **ComfyUI MCP**: `.mcp.json` 생성됨, Claude Code 재시작 후 활성화
- **다음 작업**: MCP tools로 워크플로우 직접 실행/디버그하여 방향 일관성 추가 개선
- 현재 설정: ControlNet 0.85 + IP-Adapter 0.6(endAt 0.5) + Up에 ControlNet 없음
